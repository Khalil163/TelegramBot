from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from data import sql
from aiogram.utils.callback_data import CallbackData
import requests
from create__bot import API_TAXI
import json


cb = CallbackData('clt', 'type', 'category', 'product', 'price')


async def acs_butt(id):
    price = (await sql.get_info(id))[6]
    b_y = InlineKeyboardButton('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', callback_data=f'clt:pay_a:true:{id}:{price}')
    b_n = InlineKeyboardButton('–û—Ç–∫–ª–æ–Ω–∏—Ç—å', callback_data=f'clt:pay_a:false:{id}:{price}')
    kb = InlineKeyboardMarkup(row_width=1).add(b_y).add(b_n)
    return kb


async def express(id):
    b_ord = InlineKeyboardButton('–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏', callback_data=f'clt:taxi_o:{id}:-:-')
    kb = InlineKeyboardMarkup().add(b_ord)
    return kb


async def canc_express(id):
    b_ord = InlineKeyboardButton('–û—Ç–º–µ–Ω–∏—Ç—å —Ç–∞–∫—Å–∏', callback_data=f'clt:taxi_canc:{id}:-:-')
    b2_ord = InlineKeyboardButton('–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑', callback_data=f'clt:dv_finish:{id}:-:-')
    kb = InlineKeyboardMarkup(row_width=1).add(b2_ord).add(b_ord)
    return kb


async def fd_ready(id):
    b_ord = InlineKeyboardButton('–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤', callback_data=f'clt:fd_ready:{id}:-:-')
    kb = InlineKeyboardMarkup().add(b_ord)
    return kb


async def kb_finish(id):
    b_ord = InlineKeyboardButton('–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑', callback_data=f'clt:dv_finish:{id}:-:-')
    kb = InlineKeyboardMarkup().add(b_ord)
    return kb


async def kb_pkp(id):
    b_ord = InlineKeyboardButton('–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑', callback_data=f'clt:pkp_finish:{id}:-:-')
    kb = InlineKeyboardMarkup().add(b_ord)
    return kb


site = InlineKeyboardButton('–°–∞–π—Ç', url='https://yandex.ru/maps/org/lazzat/36507547565/?ll=49.408934%2C53.518607&z=12')
Zero = InlineKeyboardButton('–ú–µ–Ω—é', url='https://sabyget.ru/shop/lazzat/catalog')
kb_info = InlineKeyboardMarkup(row_width=1).add(site).add(Zero)


b_state = KeyboardButton('–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞')
kb_state = ReplyKeyboardMarkup(resize_keyboard=True).add(b_state)

b_menu = KeyboardButton('–ú–µ–Ω—é')
b_order = KeyboardButton('–ó–∞–∫–∞–∑–∞—Ç—å')
b_loc = KeyboardButton('–ü–æ–¥–µ–ª–∏—Ç—å—Å—è üìç', request_location=True)
b_canc = KeyboardButton('–û—Ç–º–µ–Ω–∞')
b_time = KeyboardButton('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è')
s_num = KeyboardButton('–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º', request_contact=True)
s_loc = KeyboardButton('–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º', request_location=True)

share_num = ReplyKeyboardMarkup(resize_keyboard=True).add(s_num).add(b_canc)

in_delivary = InlineKeyboardButton('–î–æ—Å—Ç–∞–≤–∫–∞', callback_data='–î–æ—Å—Ç–∞–≤–∫–∞')
in_self = InlineKeyboardButton('–°–∞–º–æ–≤—ã–≤–æ–∑', callback_data='–°–∞–º–æ–≤—ã–≤–æ–∑')
in_choice = InlineKeyboardMarkup(row_width=1).add(in_delivary).add(in_self)

share_loc = ReplyKeyboardMarkup(resize_keyboard=True).add(b_loc).add(b_canc)

kb_client = ReplyKeyboardMarkup(resize_keyboard=True)
kb_adm = ReplyKeyboardMarkup(resize_keyboard=True)

kb_client.add(b_order).add(b_loc).insert(b_time)
kb_adm.add(b_order).add(b_loc, b_time).add(KeyboardButton('ModerMod'))

ib_right = InlineKeyboardButton('–î–∞', callback_data='loc_right')
ib_err = InlineKeyboardButton('–ù–µ—Ç', callback_data='loc_err')
kb_right = InlineKeyboardMarkup(row_width=1).row(ib_right, ib_err)


ib_y = InlineKeyboardButton('–î–∞', callback_data='order_right')
ib_n = InlineKeyboardButton('–ù–µ—Ç', callback_data='order_err')
draft_kb = InlineKeyboardMarkup(row_width=1).row(ib_y, ib_n)


b_buy = KeyboardButton('–ö—É–ø–∏—Ç—å')
b_empty_cart = KeyboardButton('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É')
b_help = KeyboardButton('–ù–∞–∑–∞–¥')
kb_order = ReplyKeyboardMarkup(resize_keyboard=True).add(b_buy).row(b_empty_cart, b_help)


async def items_ikb_clt():  # inline menu for client
    items_menu = await sql.get_items()
    items_case = InlineKeyboardMarkup(row_width=2)
    for i in items_menu:
        items_case.insert(InlineKeyboardButton(f'{i[0]}', callback_data=f'clt:show_clt_item:{i[0]}:-:-'))
    return items_case


async def in_plus_menu(filt, data):  # buy
    kb_i_menu = InlineKeyboardMarkup(row_width=2)
    for i in data:
        if i[2] == filt and i[3] == '–ï–°–¢–¨':
            kb_i_menu.insert(InlineKeyboardButton(f'{i[0]} - {i[1]}—Ä üîº', callback_data=f'clt:plus:{i[2]}:{i[0]}:{i[1]}'))
    return kb_i_menu.add(InlineKeyboardButton('–£–º–µ–Ω—å—à–∏—Ç—å', callback_data=f'clt:buy:minus_menu:-:-')).\
        insert(InlineKeyboardButton('–ù–∞–∑–∞–¥', callback_data='clt:buy:–ù–∞–∑–∞–¥:-:-'))


async def in_minus_menu(filt, data):  # buy
    kb_i_menu = InlineKeyboardMarkup(row_width=2)
    for i in data:
        if i[2] == filt and i[3] == '–ï–°–¢–¨':
            kb_i_menu.insert(InlineKeyboardButton(f'{i[0]} - {i[1]}—Ä üîΩ', callback_data=f'clt:minus:{i[2]}:{i[0]}:{i[1]}'))
    return kb_i_menu.add(InlineKeyboardButton('–£–≤–µ–ª–∏—á–∏—Ç—å', callback_data='clt:buy:plus_menu:-:-')).\
        insert(InlineKeyboardButton('–ù–∞–∑–∞–¥', callback_data='clt:buy:–ù–∞–∑–∞–¥:-:-'))


async def get_price(user_id):
    mas = await sql.get_info(user_id)
    long = mas[4]
    lat = mas[5]
    number = mas[0][3]

    res = {
        "items": [
            {
                "quantity": 1,
                'height ': 0.5,
                'length': 0.5,
                'width ': 0.5,
            }
        ],
        "requirements": {
            "taxi_class": 'express'
        },
        "route_points": [
            {
                "coordinates": [
                    49.408787,
                    53.518245
                ],
                "fullname": '–†–æ—Å—Å–∏—è, –¢–æ–ª—å—è—Ç—Ç–∏, —É–ª–∏—Ü–∞ –ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è, 62c5'
            },
            {
                "coordinates": [
                    long,
                    lat
                ],
                "fullname": f'{mas[11]}'
            }
        ],
        "skip_door_to_door": False 
    }

    res = requests.post(f'https://b2b.taxi.yandex.net/b2b/cargo/integration/v2/check-price',
                        headers={"Authorization": f'Bearer {API_TAXI}', 'Accept-Language': 'ru'}, json=res)

    print(long, lat, mas[11])
    print(res.text)
    obj = json.loads(res.text)
    a = str(obj['price'])
    print(a)
    return a


async def check(delivery, id):
    load = await sql.get_cart(id)
    old = ''
    sum = 0

    for i in load:
        old += '<u>{0:<1}</u>  {1:^1} * {2:^1} {3:^1} {4:>1}\n'.format(i[1], i[2], i[3], '=', i[2] * i[3])
        sum += int(i[2]) * int(i[3])
    if int(delivery) == 0:
        old += '\n<b>–ò—Ç–æ–≥–æ:</b>{:5}\n'.format(sum)
    else:
        sum += int(delivery)
        old += '\n<b>–î–æ—Å—Ç–∞–≤–∫–∞:</b>{:5}\n<b>–ò—Ç–æ–≥–æ:</b>{:5}\n'.format(int(delivery), sum)
    return old